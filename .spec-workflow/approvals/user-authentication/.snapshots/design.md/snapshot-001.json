{
  "id": "snapshot_1762365977912_zax2049nk",
  "approvalId": "approval_1762365977899_7gy4rw219",
  "approvalTitle": "批准用户认证功能设计文档",
  "version": 1,
  "timestamp": "2025-11-05T18:06:17.912Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Design Document - 用户认证功能\n\n## Overview\n\n用户认证功能是Emby服务器管理平台的核心安全模块，提供完整的用户身份验证、会话管理和权限控制系统。该功能采用JWT令牌机制实现无状态认证，集成Gin中间件进行路由保护，并通过分层架构设计确保代码的可维护性和扩展性。\n\n## Steering Document Alignment\n\n### Technical Standards\n- **Go最佳实践**: 使用标准的Go项目布局，遵循Go官方推荐的目录结构\n- **模块化设计**: 认证模块独立封装，与业务逻辑解耦\n- **TypeScript前端**: 使用类型安全的TypeScript定义认证相关的接口和类型\n- **Vue3组合式API**: 使用最新的Vue3 Composition Pattern构建认证相关组件\n\n### Project Structure\n遵循项目已建立的结构规范：\n- `internal/`: 内部业务逻辑包\n- `pkg/`: 可复用的公共包\n- `src/`: 前端源码，按功能模块组织\n\n## Code Reuse Analysis\n\n### Existing Components to Leverage\n- **Config Management (`internal/config`)**: 复用现有配置管理系统，添加JWT相关配置项\n- **Database Layer (`pkg/database`)**: 利用已建立的数据库连接和GORM ORM\n- **User Models (`internal/models`)**: 扩展现有用户模型，添加认证相关字段\n- **Gin Framework**: 复用已引入的Gin Web框架\n- **JWT Package (`pkg/auth/jwt.go`)**: 利用已创建的JWT工具包\n\n### Integration Points\n- **HTTP Middleware**: 与Gin中间件系统集成，实现路由保护\n- **User Store**: 与Pinia状态管理集成，提供全局用户状态\n- **API Router**: 与现有路由系统集成，添加认证相关路由\n- **Database Schema**: 与现有用户表结构集成，添加必要字段\n\n## Architecture\n\n采用分层架构模式，确保关注点分离和模块化设计：\n\n```mermaid\ngraph TD\n    A[Frontend Vue3 App] --> B[Authentication API]\n    B --> C[JWT Middleware]\n    C --> D[Auth Service]\n    D --> E[User Repository]\n    E --> F[Database Layer]\n\n    G[JWT Utility] --> C\n    H[Config Manager] --> D\n    I[Password Hash Service] --> D\n\n    J[Login Component] --> A\n    K[User Store] --> A\n    L[Auth Guard] --> A\n```\n\n### Modular Design Principles\n- **Single File Responsibility**: 每个文件专注于单一认证相关功能\n- **Component Isolation**: 认证逻辑、密码处理、令牌管理各自独立\n- **Service Layer Separation**: 数据访问、业务逻辑、API处理分层隔离\n- **Utility Modularity**: JWT工具、密码哈希工具模块化封装\n\n## Components and Interfaces\n\n### Backend Components\n\n#### 1. Auth Middleware (`internal/middleware/auth.go`)\n- **Purpose:** JWT令牌验证和路由保护\n- **Interfaces:**\n  - `JWTAuth()` gin.HandlerFunc\n- **Dependencies:** JWT utility, Gin framework\n- **Reuses:** Existing middleware structure\n\n#### 2. Auth Service (`internal/services/auth.go`)\n- **Purpose:** 认证业务逻辑处理\n- **Interfaces:**\n  - `Login(username, password) (*LoginResponse, error)`\n  - `Register(user *User) error`\n  - `RefreshToken(token) (string, error)`\n- **Dependencies:** User repository, JWT utility, password service\n- **Reuses:** Existing service pattern\n\n#### 3. User Repository (`internal/repositories/user.go`)\n- **Purpose:** 用户数据访问层\n- **Interfaces:**\n  - `FindByUsername(username) (*User, error)`\n  - `Create(user *User) error`\n  - `Update(user *User) error`\n- **Dependencies:** GORM, User model\n- **Reuses:** Database connection management\n\n#### 4. Hash Service (`pkg/utils/hash.go`)\n- **Purpose:** 密码哈希和验证\n- **Interfaces:**\n  - `HashPassword(password) (string, error)`\n  - `CheckPassword(password, hash) bool`\n- **Dependencies:** bcrypt, crypto/rand\n- **Reuses:** None (new utility)\n\n### Frontend Components\n\n#### 1. Login Component (`src/views/Login.vue`)\n- **Purpose:** 用户登录界面\n- **Interfaces:**\n  - `login(credentials: LoginRequest): Promise<void>`\n- **Dependencies:** User store, Router, Element Plus\n- **Reuses:** Existing Vue3 composition API pattern\n\n#### 2. User Store (`src/stores/user.ts`)\n- **Purpose:** 全局用户状态管理\n- **Interfaces:**\n  - `login(credentials)`: 登录流程\n  - `logout()`: 登出流程\n  - `refreshToken()`: 令牌刷新\n  - `updateProfile(data)`: 用户信息更新\n- **Dependencies:** Request service, LocalStorage\n- **Reuses:** Pinia pattern, request interceptor\n\n#### 3. Request Service (`src/services/request.ts`)\n- **Purpose:** HTTP请求封装和拦截器\n- **Interfaces:**\n  - Axios instance with auth headers\n  - Auto token refresh logic\n- **Dependencies:** Axios, User store\n- **Reuses:** Existing request configuration\n\n## Data Models\n\n### User Model Extension\n```go\ntype User struct {\n    ID        uint           `gorm:\"primaryKey\" json:\"id\"`\n    Username  string         `gorm:\"unique;not null\" json:\"username\"`\n    Email     string         `gorm:\"unique\" json:\"email\"`\n    Password  string         `gorm:\"not null\" json:\"-\"`\n    Role      string         `gorm:\"default:user\" json:\"role\"` // admin, user\n    Avatar    string         `json:\"avatar\"`\n    Status    string         `gorm:\"default:active\" json:\"status\"` // active, inactive, banned\n    FailedAttempts int       `gorm:\"default:0\" json:\"-\"`\n    LockedUntil    *time.Time `json:\"-\"`\n    CreatedAt time.Time      `json:\"created_at\"`\n    UpdatedAt time.Time      `json:\"updated_at\"`\n    DeletedAt gorm.DeletedAt `gorm:\"index\" json:\"-\"`\n}\n```\n\n### Login Response Model\n```go\ntype LoginResponse struct {\n    Token string `json:\"token\"`\n    User  User   `json:\"user\"`\n    ExpiresAt time.Time `json:\"expires_at\"`\n}\n```\n\n### Frontend Login Request\n```typescript\nexport interface LoginRequest {\n  username: string\n  password: string\n}\n\nexport interface LoginResponse {\n  token: string\n  user: User\n  expires_at: string\n}\n```\n\n## Error Handling\n\n### Error Scenarios\n\n1. **Invalid Credentials**\n   - **Handling:** 返回401状态码，错误代码\"INVALID_CREDENTIALS\"\n   - **User Impact:** 显示\"用户名或密码错误\"提示\n\n2. **Account Locked**\n   - **Handling:** 返回403状态码，错误代码\"ACCOUNT_LOCKED\"\n   - **User Impact:** 显示\"账户已被锁定，请30分钟后再试\"\n\n3. **Token Expired**\n   - **Handling:** 自动刷新令牌，刷新失败则重定向登录页\n   - **User Impact:** 无感知令牌刷新，失败时提示\"登录已过期\"\n\n4. **Insufficient Permissions**\n   - **Handling:** 返回403状态码，错误代码\"INSUFFICIENT_PERMISSIONS\"\n   - **User Impact:** 显示\"权限不足，无法访问该功能\"\n\n5. **Rate Limiting**\n   - **Handling:** 限制登录请求频率，返回429状态码\n   - **User Impact:** 显示\"请求过于频繁，请稍后再试\"\n\n## Testing Strategy\n\n### Unit Testing\n- **JWT Utility Testing**: 令牌生成、验证、刷新逻辑测试\n- **Hash Service Testing**: 密码哈希和验证功能测试\n- **Auth Service Testing**: 登录、注册、权限验证逻辑测试\n- **User Repository Testing**: 数据库CRUD操作测试\n\n### Integration Testing\n- **Auth API Endpoints**: 完整的登录注册流程测试\n- **Middleware Integration**: 路由保护功能测试\n- **Database Integration**: 用户数据持久化测试\n- **Frontend-Backend Integration**: 完整认证流程测试\n\n### End-to-End Testing\n- **Login Flow**: 从登录页面到仪表板的完整流程\n- **Token Refresh**: 令牌自动刷新场景测试\n- **Permission Control**: 不同角色访问权限测试\n- **Session Management**: 多设备登录和会话管理测试",
  "fileStats": {
    "size": 7457,
    "lines": 212,
    "lastModified": "2025-11-05T18:06:10.506Z"
  },
  "comments": []
}