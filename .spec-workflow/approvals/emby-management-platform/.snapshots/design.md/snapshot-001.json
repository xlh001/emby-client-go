{
  "id": "snapshot_1762366224199_pxs6fc68t",
  "approvalId": "approval_1762366224186_rq112pefp",
  "approvalTitle": "批准Emby服务器管理平台技术设计文档",
  "version": 1,
  "timestamp": "2025-11-05T18:10:24.199Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Design Document - Emby服务器管理平台\n\n## Overview\n\nEmby服务器管理平台采用现代化的前后端分离架构，基于Go Gin框架和Vue3技术栈构建。平台设计遵循领域驱动设计原则，支持微服务演化，提供高可用、高性能、可扩展的多服务器Emby管理解决方案。\n\n## Steering Document Alignment\n\n### Technical Standards\n- **Go微服务就绪**: 虽然当前采用单体架构，但设计上支持未来微服务拆分\n- **TypeScript前端**: 强类型约束的Vue3 + TypeScript + Vite技术栈\n- **容器化优先**: 原生Docker支持，Kubernetes生产部署\n- **API优先设计**: RESTful API + OpenAPI文档规范\n\n### Project Structure\n遵循标准的Go项目布局和Vue3最佳实践：\n```\nbackend/\n├── cmd/server/          # 应用入口\n├── internal/           # 内部业务逻辑\n├── pkg/                # 可复用包\n└── configs/            # 配置文件\nfrontend/\n├── src/\n│   ├── components/     # Vue组件\n│   ├── views/         # 页面组件\n│   ├── stores/        # Pinia状态管理\n│   └── services/      # API服务层\n```\n\n## Code Reuse Analysis\n\n### Existing Components to Leverage\n- **Go Base Framework**: Gin + GORM + JWT + Viper + Logrus 已配置完成\n- **Database Models**: 用户、服务器、设备、媒体、播放记录模型已定义\n- **Vue3 Frontend Skeleton**: 路由、状态管理、组件结构已搭建\n- **Docker Development**: 完整的开发环境容器化配置\n\n### Integration Points\n- **Emby API Client**: 需要创建标准化的Emby API客户端\n- **Multi-Database Support**: 现有GORM配置支持SQLite/PG/MySQL\n- **Authentication System**: JWT中间件和前端状态管理已准备\n- **WebSocket Integration**: 实时状态更新和通知系统\n\n## Architecture\n\n### 整体架构图\n\n```mermaid\ngraph TB\n    subgraph \"前端层\"\n        A[Vue3 Dashboard] --> B[Pinia Stores]\n        B --> C[API Services]\n        C --> D[WebSocket Client]\n    end\n\n    subgraph \"API网关层\"\n        E[Gin HTTP Server] --> F[JWT Middleware]\n        F --> G[CORS Middleware]\n        G --> H[Rate Limiting]\n    end\n\n    subgraph \"业务服务层\"\n        I[User Service] --> J[Emby Server Service]\n        J --> K[Media Library Service]\n        K --> L[Playback Control Service]\n        L --> M[Device Management Service]\n    end\n\n    subgraph \"数据访问层\"\n        N[User Repository] --> O[GORM ORM]\n        P[Server Repository] --> O\n        Q[Media Repository] --> O\n        R[Playback Repository] --> O\n    end\n\n    subgraph \"外部集成\"\n        S[Emby API Clients] --> T[Multiple Emby Servers]\n        U[Redis Cache] --> V[Session Store]\n        W[Database] --> X[SQLite/PG/MySQL]\n    end\n\n    D --> E\n    H --> I\n    O --> W\n    I --> S\n    J --> S\n    K --> S\n    L --> S\n```\n\n### 模块化设计原则\n\n**领域驱动设计**:\n- **User Domain**: 用户认证、权限管理、个人资料\n- **Emby Server Domain**: 服务器连接、状态监控、配置管理\n- **Media Domain**: 媒体库管理、搜索聚合、元数据同步\n- **Playback Domain**: 播放控制、进度同步、历史记录\n- **Device Domain**: 设备注册、状态监控、会话管理\n\n**技术层分离**:\n- **Presentation Layer**: HTTP API路由和权限检查\n- **Application Layer**: 业务逻辑编排和事务处理\n- **Domain Layer**: 领域模型和业务规则\n- **Infrastructure Layer**: 数据访问、外部服务、技术实现\n\n## Components and Interfaces\n\n### 后端核心组件\n\n#### 1. 用户认证模块 (`internal/services/auth.go`)\n- **Purpose**: 统一用户认证和授权管理\n- **Interfaces:**\n  - `Login(username, password) (*LoginResponse, error)`\n  - `Register(user *User) error`\n  - `RefreshToken(token) (string, error)`\n  - `ValidatePermissions(userID, resource, action) bool`\n- **Dependencies:** JWT工具、用户存储、密码哈希服务\n\n#### 2. Emby服务器管理模块 (`internal/services/emby.go`)\n- **Purpose**: Emby服务器连接和状态管理\n- **Interfaces:**\n  - `AddServer(server *EmbyServer) error`\n  - `TestConnection(server *EmbyServer) (*ConnectionTest, error)`\n  - `SyncServerInfo(serverID uint) error`\n  - `GetAllServers() ([]EmbyServer, error)`\n- **Dependencies:** Emby API客户端、状态监控器\n\n#### 3. 媒体聚合服务 (`internal/services/media.go`)\n- **Purpose**: 跨服务器媒体库聚合和搜索\n- **Interfaces:**\n  - `GetAllLibraries() ([]MediaLibrary, error)`\n  - `SearchMedia(query *SearchQuery) (*SearchResult, error)`\n  - `SyncLibrary(libraryID uint) error`\n  - `GetMediaDetail(mediaID string) (*MediaItem, error)`\n- **Dependencies:** 多个Emby API客户端、缓存服务\n\n#### 4. 播放控制服务 (`internal/services/playback.go`)\n- **Purpose**: 远程播放控制和进度同步\n- **Interfaces:**\n  - `StartPlayback(deviceID, mediaID) error`\n  - `ControlPlayback(control *PlaybackCommand) error`\n  - `SyncProgress(progress *PlaybackProgress) error`\n  - `PlaybackHistory(userID, limit) ([]PlaybackRecord, error)`\n- **Dependencies:** 设备管理、Emby API客户端、WebSocket\n\n#### 5. 设备管理服务 (`internal/services/device.go`)\n- **Purpose**: 设备注册和状态监控\n- **Interfaces:**\n  - `RegisterDevice(device *Device) error`\n  - `UpdateDeviceStatus(deviceID, status) error`\n  - `GetUserDevices(userID) ([]Device, error)`\n  - `CleanupInactiveDevices() error`\n- **Dependencies:** 设备存储、状态监控器\n\n### 前端核心组件\n\n#### 1. 认证管理组件 (`src/stores/auth.ts`)\n- **Purpose**: 全局认证状态和令牌管理\n- **Interfaces:**\n  - `login(credentials): Promise<void>`\n  - `logout(): void`\n  - `refreshToken(): Promise<void>`\n  - `checkAuth(): boolean`\n- **Dependencies:** API服务、localStorage、路由守卫\n\n#### 2. 服务器管理组件 (`src/stores/servers.ts`)\n- **Purpose:** Emby服务器状态和操作管理\n- **Interfaces:**\n  - `loadServers(): Promise<EmbyServer[]>`\n  - `addServer(server): Promise<void>`\n  - `testConnection(server): Promise<boolean>`\n  - `syncServer(serverID): Promise<void>`\n- **Dependencies:** API服务、WebSocket\n\n#### 3. 媒体浏览组件 (`src/stores/media.ts`)\n- **Purpose:** 媒体库浏览和搜索状态管理\n- **Interfaces:**\n  - `loadLibraries(): Promise<MediaLibrary[]>`\n  - `searchMedia(query): Promise<SearchResult>`\n  - `loadMediaDetail(mediaID): Promise<MediaItem>`\n  - `syncLibrary(libraryID): Promise<void>`\n- **Dependencies:** API服务、缓存层\n\n#### 4. 播放控制组件 (`src/components/MediaPlayer/`)\n- **Purpose:** 媒体播放控制和进度管理\n- **Interfaces:**\n  - `play(mediaItem): Promise<void>`\n  - `control(command): Promise<void>`\n  - `updateProgress(progress): void`\n  - `getHistory(): Promise<PlaybackRecord[]>`\n- **Dependencies:** API服务、WebSocket、音频/视频API\n\n## Data Models\n\n### 核心数据模型扩展\n\n```go\n// 用户模型扩展\ntype User struct {\n    ID            uint           `gorm:\"primaryKey\" json:\"id\"`\n    Username      string         `gorm:\"unique;not null\" json:\"username\"`\n    Email         string         `gorm:\"unique\" json:\"email\"`\n    Password      string         `gorm:\"not null\" json:\"-\"`\n    Role          string         `gorm:\"default:user\" json:\"role\"`\n    Avatar        string         `json:\"avatar\"`\n    Status        string         `gorm:\"default:active\" json:\"status\"`\n    FailedAttempts int            `gorm:\"default:0\" json:\"-\"`\n    LockedUntil    *time.Time     `json:\"-\"`\n    Preferences    string         `json:\"preferences\"`  // JSON配置\n    CreatedAt      time.Time      `json:\"created_at\"`\n    UpdatedAt      time.Time      `json:\"updated_at\"`\n    DeletedAt      gorm.DeletedAt `gorm:\"index\" json:\"-\"`\n}\n\n// Emby服务器模型扩展\ntype EmbyServer struct {\n    ID              uint           `gorm:\"primaryKey\" json:\"id\"`\n    Name            string         `gorm:\"not null\" json:\"name\"`\n    URL             string         `gorm:\"not null\" json:\"url\"`\n    APIKey          string         `gorm:\"not null\" json:\"-\"`\n    Version         string         `json:\"version\"`\n    Status          string         `gorm:\"default:offline\" json:\"status\"`\n    LastCheck       *time.Time     `json:\"last_check\"`\n    SyncInterval    int            `gorm:\"default:300\" json:\"sync_interval\"`\n    RetryCount      int            `gorm:\"default:0\" json:\"retry_count\"`\n    Description     string         `json:\"description\"`\n    Settings        string         `json:\"settings\"`  // JSON配置\n    CreatedBy       uint           `json:\"created_by\"`\n    CreatedAt       time.Time      `json:\"created_at\"`\n    UpdatedAt       time.Time      `json:\"updated_at\"`\n    DeletedAt       gorm.DeletedAt `gorm:\"index\" json:\"-\"`\n}\n```\n\n### 前端TypeScript接口\n\n```typescript\n// 全局状态接口\nexport interface AppState {\n  user: User | null\n  servers: EmbyServer[]\n  isLoading: boolean\n  notifications: Notification[]\n}\n\n// WebSocket消息\nexport interface WebSocketMessage {\n  type: 'server_status' | 'device_status' | 'playback_update'\n  data: any\n  timestamp: string\n}\n\n// 搜索请求接口\nexport interface SearchQuery {\n  keyword?: string\n  type?: 'movie' | 'series' | 'episode' | 'music'\n  libraryIds?: number[]\n  serverIds?: number[]\n  page?: number\n  pageSize?: number\n  sortBy?: 'title' | 'year' | 'rating' | 'date'\n  sortOrder?: 'asc' | 'desc'\n}\n```\n\n## Error Handling\n\n### 分层错误处理策略\n\n#### 1. API层错误\n```go\ntype APIError struct {\n    Code    string `json:\"code\"`\n    Message string `json:\"message\"`\n    Details any    `json:\"details,omitempty\"`\n}\n\n// 预定义错误代码\nconst (\n    ErrInvalidCredentials = \"INVALID_CREDENTIALS\"\n    ErrInsufficientPermissions = \"INSUFFICIENT_PERMISSIONS\"\n    ErrServerUnavailable = \"SERVER_UNAVAILABLE\"\n    ErrResourceNotFound = \"RESOURCE_NOT_FOUND\"\n    ErrRateLimitExceeded = \"RATE_LIMIT_EXCEEDED\"\n    ErrEmbyConnectionFailed = \"EMBY_CONNECTION_FAILED\"\n)\n```\n\n#### 2. 业务逻辑错误\n- **认证失败**: 详细区分用户名错误、密码错误、账户锁定\n- **连接错误**: 区分网络超时、认证失败、API不兼容\n- **数据同步错误**: 重试机制、部分失败处理、回滚策略\n\n#### 3. 前端错误处理\n```typescript\n// 全局错误处理\nclass ErrorHandler {\n  static handle(error: APIError) {\n    switch (error.code) {\n      case 'INVALID_CREDENTIALS':\n        ElMessage.error('用户名或密码错误')\n        break\n      case 'EMBY_CONNECTION_FAILED':\n        ElMessage.warning('Emby服务器连接失败，请检查网络')\n        break\n      // ... 其他错误处理\n    }\n  }\n}\n```\n\n## Testing Strategy\n\n### 分层测试策略\n\n#### 1. 单元测试 (Backend)\n- **Service层测试**: 认证、服务器管理、媒体服务核心逻辑\n- **Repository层测试**: 数据库CRUD操作、查询优化\n- **Utility测试**: JWT工具、密码哈希、Emby API客户端\n\n#### 2. 单元测试 (Frontend)\n- **Store测试**: Pinia状态管理、计算属性\n- **组件测试**: Vue组件渲染、用户交互\n- **服务测试**: API客户端、WebSocket连接\n\n#### 3. 集成测试\n- **API集成测试**: 完整的HTTP请求-响应流程\n- **数据库集成**: 跨表查询、事务处理\n- **Emby API集成**: 真实服务器连接测试\n\n#### 4. 端到端测试\n- **用户注册登录流程**\n- **服务器添加和管理流程**\n- **媒体搜索和播放流程**\n- **多设备同步测试**\n- **多服务器聚合测试**\n\n### 测试环境配置\n- **开发测试**: SQLite内存数据库，模拟Emby服务器\n- **集成测试**: PostgreSQL Docker容器，真实Emby实例\n- **E2E测试**: Playwright自动化浏览器测试\n\n## Security Architecture\n\n### 多层安全体系\n\n#### 1. 认证安全\n- **密码安全**: bcrypt哈希，成本因子12+\n- **令牌安全**: HS256 JWT，15分钟有效期，自动刷新\n- **会话管理**: Redis存储活跃会话，支持强制下线\n\n#### 2. API安全\n- **JWT中间件**: 统一令牌验证，过期检查\n- **权限控制**: 基于角色的访问控制(RBAC)\n- **限流保护**: IP级别和用户级别的限流\n- **CORS配置**: 严格的跨域资源共享策略\n\n#### 3. 数据安全\n- **传输加密**: 所有API请求HTTPS强制\n- **存储加密**: API密钥和敏感配置加密存储\n- **输入验证**: 严格的参数验证和SQL注入防护\n\n### 部署安全\n- **容器安全**: 最小Docker镜像，非root用户运行\n- **网络安全**: 内部服务通信，防火墙配置\n- **监控告警**: 异常登录检测、安全事件日志",
  "fileStats": {
    "size": 12470,
    "lines": 367,
    "lastModified": "2025-11-05T18:10:14.984Z"
  },
  "comments": []
}